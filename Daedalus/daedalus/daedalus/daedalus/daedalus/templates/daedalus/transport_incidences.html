{% extends "daedalus/base.html" %}

{% block content %}
<div style="padding:20px; max-width:1200px; margin:0 auto; font-size:1em;">
  <h2 style="margin:0 0 16px 0; font-size:1.3em; border-bottom:2px solid #EEE; padding-bottom:8px;">Transport incidences</h2>

  {% if message %}
    <div style="background:#ecfdf5; border:1px solid #a7f3d0; color:#047857; padding:12px; border-radius:8px; margin-bottom:18px;">
      <div style="font-weight:600;">Success!</div>
      {{ message }}
    </div>
  {% endif %}
  {% if error %}
    <div style="background:#fef2f2; border:1px solid #fecaca; color:#991b1b; padding:12px; border-radius:8px; margin-bottom:18px;">
      <div style="font-weight:600;">Error:</div>
      {{ error }}
    </div>
  {% endif %}

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
    <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05);">
      <h3 style="margin:0 0 15px 0; color:#2563EB; border-bottom:2px solid #F3F4F6; padding-bottom:5px;">Create / activate incidence</h3>

      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_or_activate" />

        <div style="display:grid; gap:15px;">
          <label style="font-size:0.85em; font-weight:600; display:block;">
            Incidence ID (optional)
            <input name="incidencia_id" placeholder="INC001 (leave empty to auto-generate)"
                   style="width:100%; padding:10px; border:1px solid #CCC; border-radius:6px; margin-top:4px; box-sizing:border-box;" />
          </label>

          <label style="font-size:0.85em; font-weight:600; display:block;">
            Mode
            <select name="modo" style="width:100%; padding:10px; border:1px solid #CCC; border-radius:6px; margin-top:4px; box-sizing:border-box;">
              <option value="metro">metro</option>
              <option value="cercanias">cercanias</option>
            </select>
          </label>

          <label style="font-size:0.85em; font-weight:600; display:block;">
            Line
            <input name="linea" placeholder="e.g. 9"
                   style="width:100%; padding:10px; border:1px solid #CCC; border-radius:6px; margin-top:4px; box-sizing:border-box;" />
          </label>

          <label style="font-size:0.85em; font-weight:600; display:block;">
            From stop_id
            <input name="stop_desde" placeholder="e.g. par_4_174"
                   style="width:100%; padding:10px; border:1px solid #CCC; border-radius:6px; margin-top:4px; box-sizing:border-box;" />
          </label>

          <label style="font-size:0.85em; font-weight:600; display:block;">
            To stop_id
            <input name="stop_hasta" placeholder="e.g. par_4_179"
                   style="width:100%; padding:10px; border:1px solid #CCC; border-radius:6px; margin-top:4px; box-sizing:border-box;" />
          </label>

          <button type="submit"
            style="padding:12px; border-radius:8px; border:0; background:#2563EB; color:white; cursor:pointer; font-weight:600; margin-top:5px;">
            Activate incidence
          </button>
        </div>
      </form>

      <div style="margin-top:15px; font-size:0.75em; color:#6b7280; border-top:1px solid #EEE; padding-top:10px;">
        Tip: this will cut the whole segment inside that line between From→To (both directions),
        as in your RouteCalculator logic.
      </div>
    </div>

    <div style="background:white; border:1px solid #e5e7eb; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05);">
      <h3 style="margin:0 0 15px 0; color:#2563EB; border-bottom:2px solid #F3F4F6; padding-bottom:5px;">Active incidences</h3>

      {% if incidences_active %}
        <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:10px;">
          <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
            <thead>
              <tr style="background:#F3F4F6;">
                <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">ID</th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">Mode</th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">Line</th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">From</th>
                <th style="text-align:left; padding:10px; border-bottom:1px solid #e5e7eb;">To</th>
                <th style="padding:10px; border-bottom:1px solid #e5e7eb;"></th>
              </tr>
            </thead>
            <tbody>
              {% for inc in incidences_active %}
                <tr>
                  <td style="padding:10px; border-bottom:1px solid #f1f5f9;">{{ inc.id }}</td>
                  <td style="padding:10px; border-bottom:1px solid #f1f5f9;">{{ inc.modo }}</td>
                  <td style="padding:10px; border-bottom:1px solid #f1f5f9;">{{ inc.linea }}</td>
                  <td style="padding:10px; border-bottom:1px solid #f1f5f9;">{{ inc.stop_desde }}</td>
                  <td style="padding:10px; border-bottom:1px solid #f1f5f9;">{{ inc.stop_hasta }}</td>
                  <td style="padding:10px; border-bottom:1px solid #f1f5f9; text-align:right;">
                    <form method="post" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="deactivate" />
                      <input type="hidden" name="incidencia_id" value="{{ inc.id }}" />
                      <button type="submit"
                        style="padding:6px 12px; border-radius:6px; border:1px solid #FCA5A5; background:#FEE2E2; color:#B91C1C; cursor:pointer; font-size:0.9em; font-weight:600;">
                        Deactivate
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div style="color:#6b7280; font-size:0.9em; padding:10px; background:#F9FAFB; border-radius:6px;">No active incidences.</div>
      {% endif %}
    </div>
  </div>

  <div style="margin-top:20px;">
    <a href="{% url 'daedalus-transport-zones' %}" style="text-decoration:none; color:#2563EB; font-weight:600;">
      ← Back to zone selection
    </a>
  </div>
</div>
{% endblock %}