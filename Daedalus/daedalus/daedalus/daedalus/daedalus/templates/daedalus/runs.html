{% extends "daedalus/base.html" %}
{% load static %}

{% block content %}
  <div style="padding:20px; max-width:1300px; margin:0 auto; font-size:1.15em;">
    <h2 style="font-size:1.5em; margin:0 0 16px 0; border-bottom:2px solid #EEE; padding-bottom:8px;">Runs and reports</h2>

    <div style="margin-bottom:20px; display:flex; gap:12px; align-items:center;">
      <button id="btn-run-opt" type="button"
              style="padding:10px 18px; border-radius:8px; border:none;
                     background:#2563EB; color:white; cursor:pointer; font-weight:600; font-size:0.9em;">
        Launch new optimization
      </button>
      <span id="run-status" style="font-size:0.85em; color:#555;"></span>
    </div>

    <p style="font-size:0.9em; color:#6b7280; margin-bottom:15px;">
      Here you’ll see the runs generated by the engine (PuLP) with their main metrics.
    </p>

    <div style="overflow-x:auto; border:1px solid #e5e7eb; border-radius:10px;">
      <table id="runs-table" style="border-collapse:collapse; width:100%; font-size:0.9em;">
        <thead>
          <tr style="background:#111827; color:white;">
            <th style="padding:10px; text-align:left;">Run ID</th>
            <th style="padding:10px; text-align:left;">Scenario</th>
            <th style="padding:10px; text-align:left;">Date</th>
            <th style="padding:10px;">Lines ↑ </th>
            <th style="padding:10px;">Lines ↓</th>
            <th style="padding:10px; text-align:left;">Actions</th>
          </tr>
        </thead>
        <tbody id="runs-body">
          <tr><td colspan="6" style="text-align:center; padding:12px; color:#6b7280;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}


{% block extra_scripts %}
<script>
  // ======================
  // 1. Supabase config
  // ======================
  const SUPABASE_URL  = "https://rrbuwzcoiyncvmzctvnr.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyYnV3emNvaXluY3ZtemN0dm5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTcxNTMsImV4cCI6MjA3ODczMzE1M30.2pRgInMTIFJi-aPipsadQF4WzeceMjPcPXPY4PjnTss";

  function sbFetch(pathWithQuery) {
    return fetch(`${SUPABASE_URL}${pathWithQuery}`, {
      headers: {
        "apikey": SUPABASE_ANON,
        "Authorization": `Bearer ${SUPABASE_ANON}`
      }
    }).then(r => r.json());
  }

  // ======================
  // 2. Data loading logic
  // ======================
  async function loadRuns() {
    const tbody = document.getElementById("runs-body");
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:12px; color:#6b7280;">Loading...</td></tr>`;

    const runs = await sbFetch("/rest/v1/runs?select=*");

    if (!runs || runs.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:12px; color:#6b7280;">There are no runs yet.</td></tr>`;
      return;
    }

    runs.sort((a,b) => b.run_id - a.run_id);

    const rowsHtml = [];
    for (const run of runs) {
      // Fetch frequency data for each run to calculate up/down lines
      const freqData = await sbFetch(`/rest/v1/run_line_freq?run_id=eq.${run.run_id}&select=freq_before,freq_after,line_id`);

      let up = 0, down = 0;
      // Define a threshold (e.g., 1%) for significant change
      const threshold = 0.01;
      (freqData || []).forEach(r => {
        // Calculate relative change, handling division by zero for freq_before
        const deltaRel = (r.freq_after - r.freq_before) / (r.freq_before || 1);
        
        if (deltaRel > threshold) up++;
        else if (deltaRel < -threshold) down++;
      });

      const fecha = run.created_at ? new Date(run.created_at).toLocaleString() : "—";

      rowsHtml.push(`
        <tr style="border-bottom:1px solid #f1f5f9;">
          <td style="padding:10px;">${run.run_id}</td>
          <td style="padding:10px;">${run.scenario || '<span style="color:#9ca3af;">(N/A)</span>'}</td>
          <td style="padding:10px;">${fecha}</td>
          <td style="padding:10px; text-align:center;">
            <span style="color:#10B981; font-weight:600;">${up}</span>
          </td>
          <td style="padding:10px; text-align:center;">
            <span style="color:#EF4444; font-weight:600;">${down}</span>
          </td>
          <td style="padding:10px;">
            <a href="{% url 'daedalus-dashboard' %}?run=${run.run_id}" style="color:#2563EB; text-decoration:none;">
              Dashboard
            </a>
            |
            <a href="{% url 'daedalus-dynamic' %}?run=${run.run_id}" style="color:#2563EB; text-decoration:none;">
              Dynamic Map
            </a>
          </td>
        </tr>
      `);
    }

    tbody.innerHTML = rowsHtml.join("");
  }

  // ======================
  // 3. Button logic
  // ======================
  document.getElementById("btn-run-opt").addEventListener("click", async () => {
    const statusSpan = document.getElementById("run-status");
    const button = document.getElementById("btn-run-opt");
    
    // Disable button and show loading state
    button.disabled = true;
    button.style.opacity = 0.7;
    statusSpan.style.color = "#555";
    statusSpan.textContent = "Launching optimization (PuLP)...";

    try {
      const res = await fetch("{% url 'daedalus-run-opt' %}", {
        method: "POST",
        headers: {
          // As we set @csrf_exempt on the view, CSRF header is not required here
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      const data = await res.json();

      if (data.status === "ok") {
        statusSpan.style.color = "#10B981"; // Green
        statusSpan.textContent = "Optimization completed successfully ✅";
        console.log("Engine stdout:", data.stdout);
        // After a run, reload runs table
        loadRuns();
      } else {
        statusSpan.style.color = "#EF4444"; // Red
        statusSpan.textContent = "Engine error ❌ (see console)";
        console.error("Engine error:", data.stderr || data.stdout);
      }
    } catch (err) {
      statusSpan.style.color = "#EF4444"; // Red
      statusSpan.textContent = "Failed to call engine ❌";
      console.error(err);
    } finally {
      // Re-enable button after operation (success or failure)
      button.disabled = false;
      button.style.opacity = 1;
    }
  });

  // Load runs on page load
  loadRuns();
</script>
{% endblock %}